[English](./development_guide.md) | [ç®€ä½“ä¸­æ–‡](./development_guide.zh-CN.md)

---

# T4T å¼€å‘è€…æŒ‡å— (V2)

æ¬¢è¿æ¥åˆ° T4T V2 æ¨¡å—å¼€å‘çš„ä¸–ç•Œï¼æœ¬æ–‡æ¡£å°†å¼•å¯¼æ‚¨äº†è§£æ–°çš„äº‹ä»¶é©±åŠ¨æ¶æ„ã€æ ¸å¿ƒæ¦‚å¿µä»¥åŠå¦‚ä½•æ„å»ºä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„ V2 æ¨¡å—ã€‚

## 1. V2 æ¨¡å—ç»“æ„æ¦‚è§ˆ

ä¸€ä¸ª V2 æ¨¡å—ç”±ä¸¤ä¸ªæ ¸å¿ƒæ–‡ä»¶ç»„æˆï¼Œå®ƒä»¬å…±åŒå®šä¹‰äº†æ¨¡å—çš„è¡Œä¸ºå’Œå…ƒæ•°æ®ã€‚

* **`manifest.yaml`**: è¿™æ˜¯æ¨¡å—çš„â€œèº«ä»½è¯â€ã€‚å®ƒæ˜¯ä¸€ä¸ªå£°æ˜å¼çš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºå®šä¹‰æ¨¡å—çš„åç§°ã€è§¦å‘æ–¹å¼ã€è¾“å…¥å‚æ•°ä»¥åŠå…¶ä»–å…ƒæ•°æ®ã€‚ç³»ç»Ÿé€šè¿‡è§£æè¿™ä¸ªæ–‡ä»¶æ¥äº†è§£å¦‚ä½•ä»¥åŠä½•æ—¶æ‰§è¡Œä½ çš„ä»»åŠ¡ã€‚
* **ä»»åŠ¡è„šæœ¬ (`__init__.py` æˆ–å…¶ä»–æŒ‡å®šè„šæœ¬)**: è¿™æ˜¯æ¨¡å—çš„â€œå¤§è„‘â€ï¼ŒåŒ…å«äº†å®é™…çš„ä¸šåŠ¡é€»è¾‘ã€‚å…¶æ ¸å¿ƒæ˜¯ä¸€ä¸ªåä¸º `run` çš„å‡½æ•°ï¼Œç³»ç»Ÿä¼šåœ¨è§¦å‘æ¡ä»¶æ»¡è¶³æ—¶è°ƒç”¨å®ƒã€‚

---

## 2. ç¼–å†™ä»»åŠ¡è„šæœ¬ (`run` å‡½æ•°)

V2 æ¨¡å—çš„å…¥å£ç‚¹æ˜¯ä¸€ä¸ªå…·æœ‰æ ‡å‡†ç­¾åçš„ `run` å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°çš„è®¾è®¡éµå¾ªâ€œä¾èµ–æ³¨å…¥â€çš„åŸåˆ™ï¼Œä½¿å¾—æµ‹è¯•å’Œä»£ç å¤ç”¨å˜å¾—æ›´åŠ ç®€å•ã€‚

```python
def run(context, inputs):
    """
    ä¸€ä¸ªæ ‡å‡†çš„ V2 ä»»åŠ¡å‡½æ•°ã€‚

    :param context: ç”±ç³»ç»Ÿæ³¨å…¥çš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œæä¾›å¯¹æ—¥å¿—ã€æ¶ˆæ¯æ€»çº¿ç­‰æ ¸å¿ƒæœåŠ¡çš„è®¿é—®ã€‚
    :param inputs: ä¸€ä¸ªåŒ…å«ä»»åŠ¡æ‰€éœ€è¾“å…¥æ•°æ®çš„å­—å…¸ã€‚
    """
    # ä½ çš„ä»£ç é€»è¾‘åœ¨è¿™é‡Œ
    pass
```

### 2.1. ä¸Šä¸‹æ–‡å¯¹è±¡ (`context`)

`context` å¯¹è±¡æ˜¯ä½ çš„ä»»åŠ¡ä¸ T4T ç³»ç»Ÿäº¤äº’çš„æ¡¥æ¢ã€‚å®ƒæ˜¯ä¸€ä¸ªç”±ä»»åŠ¡ç®¡ç†å™¨åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºå¹¶ä¼ å…¥çš„å®ä¾‹ï¼ŒåŒ…å«äº†æ‰§è¡Œä»»åŠ¡æ‰€éœ€çš„æ‰€æœ‰ç¯å¢ƒä¿¡æ¯å’ŒæœåŠ¡ã€‚

**`context` å¯¹è±¡çš„å±æ€§:**

| å±æ€§ | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `task_name` | `str` | å½“å‰æ‰§è¡Œçš„ä»»åŠ¡å®ä¾‹çš„åç§°ã€‚ |
| `logger` | `logging.Logger` | æ ‡å‡† Python æ—¥å¿—è®°å½•å™¨ï¼Œå¯ä½¿ç”¨ `.info()`ã€`.warning()`ã€`.error()`ã€`.debug()` ç­‰æ–¹æ³•è¾“å‡ºä»»åŠ¡çº§æ—¥å¿—ã€‚ |

**ä»£ç ç¤ºä¾‹ï¼šä½¿ç”¨ä¸Šä¸‹æ–‡æ—¥å¿—**

ä½¿ç”¨ `context.logger` è€Œä¸æ˜¯ `print()` æ˜¯æœ€ä½³å®è·µï¼Œå› ä¸ºå®ƒèƒ½å°†æ—¥å¿—ä¸ç‰¹å®šçš„ä»»åŠ¡å…³è”èµ·æ¥ï¼Œä¾¿äºè°ƒè¯•ã€‚

```python
def run(context, inputs):
    context.logger.info(f"ä»»åŠ¡ '{context.task_name}' å·²å¯åŠ¨ã€‚")

    try:
        # ... æ ¸å¿ƒé€»è¾‘ ...
        result = "æ“ä½œæˆåŠŸ"
        context.logger.info(f"å¤„ç†å®Œæˆ: {result}")
    except Exception as e:
        context.logger.error(f"ä»»åŠ¡æ‰§è¡Œå¤±è´¥: {e}")

```

### 2.2. è¾“å…¥æ•°æ® (`inputs`)

`inputs` å‚æ•°æ˜¯ä¸€ä¸ªå­—å…¸ï¼ŒåŒ…å«äº†ä»»åŠ¡æ‰§è¡Œæ‰€éœ€çš„æ‰€æœ‰æ•°æ®ã€‚è¿™äº›æ•°æ®çš„æ¥æºç”± `manifest.yaml` ä¸­çš„ `trigger` å’Œ `inputs` é…ç½®å†³å®šã€‚

* **å¯¹äºäº‹ä»¶è§¦å‘å™¨ (`event`)**: `inputs` å­—å…¸çš„é”®å€¼å¯¹é€šå¸¸æ¥è‡ªäºè§¦å‘äº‹ä»¶çš„ `payload`ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ª MQTT æ¶ˆæ¯çš„å†…å®¹ï¼‰ã€‚
* **å¯¹äºå®šæ—¶è§¦å‘å™¨ (`schedule`)**: `inputs` å­—å…¸é€šå¸¸ä¸ºç©ºï¼Œå› ä¸ºè¿™ç±»ä»»åŠ¡ä¸æ˜¯ç”±å¤–éƒ¨æ•°æ®é©±åŠ¨çš„ã€‚

---

## 3. é…ç½®æ¸…å• (`manifest.yaml`)

`manifest.yaml` æ˜¯ V2 æ¨¡å—çš„æ ¸å¿ƒï¼Œå®ƒä»¥ä¸€ç§æ¸…æ™°ã€å¯è¯»çš„æ–¹å¼å®šä¹‰äº†æ¨¡å—çš„è¡Œä¸ºã€‚

### 3.1. è§¦å‘å™¨ (`trigger`)

`trigger` å­—æ®µå®šä¹‰äº†å¯åŠ¨ä»»åŠ¡çš„æ¡ä»¶ã€‚T4T V2 æ”¯æŒä¸¤ç§ä¸»è¦çš„è§¦å‘å™¨ç±»å‹ã€‚

#### a) å®šæ—¶è§¦å‘å™¨ (`schedule`)

å½“æ‚¨å¸Œæœ›ä»»åŠ¡æŒ‰å›ºå®šçš„æ—¶é—´è¡¨ï¼ˆä¾‹å¦‚ï¼Œæ¯å°æ—¶ã€æ¯å¤©åˆå¤œï¼‰æ‰§è¡Œæ—¶ï¼Œä½¿ç”¨æ­¤è§¦å‘å™¨ã€‚å®ƒåº•å±‚ç”± `APScheduler` æ”¯æŒã€‚

**å®Œæ•´é…ç½®ç¤ºä¾‹:**

```yaml
# manifest.yaml
name: "æ¯æ—¥æŠ¥å‘Šä»»åŠ¡"
module_type: "reporting_v2"
version: "1.0"

trigger:
  type: schedule
  config:
    type: cron      # cron, interval, or date
    hour: 0         # æ¯å¤© 00:00 æ‰§è¡Œ
    minute: 0
```

#### b) äº‹ä»¶è§¦å‘å™¨ (`event`)

å½“æ‚¨å¸Œæœ›ä»»åŠ¡å“åº”ç³»ç»Ÿä¸­çš„ç‰¹å®šäº‹ä»¶ï¼ˆä¾‹å¦‚ï¼Œå¦ä¸€ä»»åŠ¡å®Œæˆã€æ”¶åˆ°ä¸€æ¡ MQTT æ¶ˆæ¯ï¼‰æ—¶ï¼Œä½¿ç”¨æ­¤è§¦å‘å™¨ã€‚è¿™æ˜¯æ„å»ºå“åº”å¼ã€è§£è€¦ç³»ç»Ÿçš„å…³é”®ã€‚

**å®Œæ•´é…ç½®ç¤ºä¾‹:**

```yaml
# manifest.yaml
name: "æ¸©åº¦ä¼ æ„Ÿå™¨å¤„ç†å™¨"
module_type: "sensor_handler_v2"
version: "1.0"

trigger:
  type: event
  config:
    topic: "sensors/temperature/reading" # è®¢é˜… MQTT ä¸»é¢˜
    max_hops: 5 # å¯é€‰ï¼Œé˜²æ­¢äº‹ä»¶é“¾è·¯å¾ªç¯è§¦å‘
```

> ğŸ’¡ **å®‰å…¨æç¤º**ï¼š`max_hops` ç”¨äºé™åˆ¶äº‹ä»¶åœ¨ä»»åŠ¡ä¹‹é—´è½¬å‘çš„æœ€å¤§è·³æ•°ã€‚å½“ payload ä¸­çš„ `__hops` å¤§äºæ­¤é˜ˆå€¼æ—¶ï¼Œä»»åŠ¡ä¼šè®°å½•é”™è¯¯å¹¶å¿½ç•¥è¯¥äº‹ä»¶ã€‚è‹¥æœªåœ¨ä»»åŠ¡ä¸­æŒ‡å®šï¼Œç³»ç»Ÿä¼šå›é€€åˆ° `config/config.ini` ä¸­ `[TaskDefaults] event_max_hops` çš„å…¨å±€é»˜è®¤å€¼ï¼ˆé»˜è®¤å€¼ï¼š`5`ï¼‰ã€‚

### 3.2. è¾“å…¥æ˜ å°„ä¸éªŒè¯ (`inputs`)

`inputs` å­—æ®µæ˜¯ `manifest.yaml` ä¸­ä¸€ä¸ªè‡³å…³é‡è¦çš„éƒ¨åˆ†ã€‚å®ƒæ‰®æ¼”ç€åŒé‡è§’è‰²ï¼š

1. **æ•°æ®æ˜ å°„**: å®ƒå£°æ˜äº†ä»»åŠ¡ `run` å‡½æ•°æœŸæœ›æ¥æ”¶å“ªäº›è¾“å…¥å‚æ•°ã€‚å¯¹äºäº‹ä»¶è§¦å‘å™¨ï¼Œç³»ç»Ÿä¼šå°è¯•ä»äº‹ä»¶çš„ `payload` ä¸­æå–è¿™äº›å­—æ®µã€‚
2. **å‰ç½®éªŒè¯**: å®ƒæ˜¯ä¿æŠ¤ä½ çš„ä»»åŠ¡å…å—æ— æ•ˆæˆ–ç¼ºå¤±æ•°æ®å½±å“çš„ç¬¬ä¸€é“é˜²çº¿ã€‚

**é‡ç‚¹: `required: true`**

å½“ä¸€ä¸ªè¾“å…¥å­—æ®µè¢«æ ‡è®°ä¸º `required: true` æ—¶ï¼Œä»»åŠ¡ç®¡ç†å™¨ä¼šåœ¨è°ƒç”¨ `run` å‡½æ•°**ä¹‹å‰**æ£€æŸ¥è¯¥å­—æ®µæ˜¯å¦å­˜åœ¨äºè¾“å…¥æ•°æ®ä¸­ã€‚å¦‚æœæ•°æ®ç¼ºå¤±ï¼Œä»»åŠ¡å°†ä¸ä¼šè¢«æ‰§è¡Œï¼Œå¹¶ä¼šåœ¨ç³»ç»Ÿæ—¥å¿—ä¸­è®°å½•ä¸€æ¡é”™è¯¯ã€‚è¿™å¯ä»¥æå¤§åœ°ç®€åŒ–ä½  `run` å‡½æ•°ä¸­çš„é”™è¯¯å¤„ç†é€»è¾‘ã€‚

**é…ç½®ç¤ºä¾‹:**

```yaml
# manifest.yaml
name: "ç”¨æˆ·æ³¨å†Œå¤„ç†å™¨"
# ... å…¶ä»–é…ç½® ...

trigger:
  type: event
  config:
    topic: "users/register"

inputs:
  - name: username
    type: string
    description: "ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚"
    required: true  # å¦‚æœ MQTT æ¶ˆæ¯ä¸­æ²¡æœ‰ username å­—æ®µï¼Œä»»åŠ¡å°†ä¸ä¼šè¿è¡Œ

  - name: email
    type: string
    description: "ç”¨æˆ·çš„ç”µå­é‚®ä»¶åœ°å€ã€‚"
    required: true

  - name: referral_code
    type: string
    description: "æ¨èç ï¼ˆå¯é€‰ï¼‰ã€‚"
    required: false # è¿™ä¸ªå­—æ®µæ˜¯å¯é€‰çš„
```

### 3.3. UI è¡¨å•æè¿°ï¼ˆ`schema`ï¼‰

`schema` æ˜¯ä¸€ä¸ªå¯é€‰çš„å…ƒæ•°æ®æ®µï¼Œç”¨æ¥å‘Šè¯‰ä»»åŠ¡ç®¡ç†å™¨å¦‚ä½•æ¸²æŸ“æ¨¡å—çš„é…ç½®è¡¨å•ã€‚æ¯ä¸ªæ¡ç›®éƒ½å¯¹åº”ä¸€ä¸ªé…ç½®é”®ï¼ˆä½¿ç”¨ç‚¹å·è¡¨ç¤ºåµŒå¥—è·¯å¾„ï¼‰ï¼Œå¹¶å¯ä»¥å£°æ˜æ ‡ç­¾ã€æè¿°ä¿¡æ¯ä»¥åŠæ‰€å±åˆ†ç»„ç­‰å±æ€§ã€‚

```yaml
schema:
  name:
    label: "ä»»åŠ¡åç§°"
    description: "åœ¨æ§åˆ¶å°ä¸­å±•ç¤ºçš„åç§°ã€‚"
    group: "åŸºç¡€ä¿¡æ¯"
  trigger:
    label: "æ‰§è¡Œè®¡åˆ’"
    group: "è°ƒåº¦"
  settings.increment_by:
    type: integer
    label: "è‡ªå¢æ­¥é•¿"
    min: 1
    group: "è®¡æ•°å™¨è®¾ç½®"
```

ç¼–å†™ `schema` æ—¶è¯·æ³¨æ„ï¼š

* **ç‚¹å·è·¯å¾„** å¯ç²¾å‡†æŒ‡å‘åµŒå¥—å­—å…¸ï¼ˆä¾‹å¦‚ `settings.increment_by`ï¼‰ã€‚
* **`group` å­—æ®µ** ç”¨äºæ§åˆ¶å­—æ®µåœ¨ UI ä¸­çš„åˆ†ç»„ï¼Œåªè¦åˆ†ç»„åç§°ç›¸åŒå°±ä¼šè‡ªåŠ¨èšåˆå¹¶ç”Ÿæˆä¸€ä¸ªæ ‡é¢˜ã€‚
* **ç‰¹æ®ŠåŒºå—**ï¼ˆå¦‚ `trigger` ä¸ `inputs`ï¼‰ä¾ç„¶ä¼šæ¸²æŸ“ä¸“å±çš„äº¤äº’ç»„ä»¶ï¼ŒåŒæ—¶å°Šé‡åœ¨ schema ä¸­å£°æ˜çš„åˆ†ç»„ä¸æ ‡ç­¾ã€‚
* **å…¼å®¹ç­–ç•¥**ï¼šæœªåœ¨ schema ä¸­å£°æ˜çš„å­—æ®µä¼šæ ¹æ®é…ç½®ç»“æ„è‡ªåŠ¨å½’ç»„ï¼›æ—§ç‰ˆä¾èµ– `properties` åµŒå¥—çš„ schema ä»ç„¶å—æ”¯æŒï¼Œæ— éœ€å¼ºåˆ¶è¿ç§»ã€‚

---

## 4. æ ¸å¿ƒæ¦‚å¿µè¯¦è§£

### 4.1. å¹¶å‘æ¨¡å‹

T4T V2 é‡‡ç”¨ `ThreadPoolExecutor` æ¥ç®¡ç†ä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ± ã€‚æ‰€æœ‰çš„ä»»åŠ¡ï¼ˆæ— è®ºæ˜¯ `schedule` è¿˜æ˜¯ `event` è§¦å‘ï¼‰éƒ½ä¼šè¢«æäº¤åˆ°è¿™ä¸ªçº¿ç¨‹æ± ä¸­å¼‚æ­¥æ‰§è¡Œã€‚

* **ä¸æ—§æ¨¡å‹çš„åŒºåˆ«**: åœ¨æ—§çš„ `APScheduler` æ¨¡å‹ä¸­ï¼Œé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡å¯èƒ½ä¼šé˜»å¡è°ƒåº¦å™¨çº¿ç¨‹ã€‚æ–°çš„çº¿ç¨‹æ± æ¨¡å‹ç¡®ä¿äº†æ¯ä¸ªä»»åŠ¡éƒ½åœ¨ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ä¸­è¿è¡Œï¼Œä»è€Œé¿å…äº†ä»»åŠ¡ä¹‹é—´çš„ç›¸äº’å¹²æ‰°ï¼Œå¹¶ä¿è¯äº†ä¸»åº”ç”¨çš„ UI å§‹ç»ˆä¿æŒå“åº”ã€‚

### 4.2. äº‹ä»¶é©±åŠ¨ä¸æ¶ˆæ¯æ€»çº¿

ç³»ç»Ÿçš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªè½»é‡çº§çš„**æ¶ˆæ¯æ€»çº¿**ï¼ˆé»˜è®¤ä½¿ç”¨ MQTT å®ç°ï¼‰ã€‚å®ƒå…è®¸ä¸åŒçš„æ¨¡å—å’Œä»»åŠ¡ä¹‹é—´ä»¥â€œå‘å¸ƒ/è®¢é˜…â€çš„æ¨¡å¼è¿›è¡Œé€šä¿¡ï¼Œè€Œæ— éœ€ç›´æ¥ç›¸äº’ä¾èµ–ã€‚

* **è§’è‰²**: æ¶ˆæ¯æ€»çº¿æ˜¯æ•´ä¸ªç³»ç»Ÿäº‹ä»¶é©±åŠ¨æ¶æ„çš„åŸºçŸ³ã€‚ä¸€ä¸ªä»»åŠ¡å¯ä»¥å‘ä¸€ä¸ªä¸»é¢˜ï¼ˆTopicï¼‰å‘å¸ƒä¸€æ¡æ¶ˆæ¯ï¼ˆä¾‹å¦‚ `task/A/completed`ï¼‰ï¼Œè€Œå…¶ä»–ä»»æ„æ•°é‡çš„ä»»åŠ¡éƒ½å¯ä»¥è®¢é˜…è¿™ä¸ªä¸»é¢˜ï¼Œå¹¶åœ¨æ¶ˆæ¯åˆ°è¾¾æ—¶è¢«è§¦å‘ã€‚è¿™ç§æ¨¡å¼æå¤§åœ°æé«˜äº†ç³»ç»Ÿçš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€‚

### 4.3. åå°æœåŠ¡ä¸ ServiceManager

`ServiceManager` è´Ÿè´£ç»Ÿä¸€ç®¡ç†åå°æœåŠ¡ï¼ˆä¾‹å¦‚åµŒå…¥å¼ MQTT Brokerï¼‰çš„ç”Ÿå‘½å‘¨æœŸã€‚ç³»ç»Ÿåœ¨ `main.py` ä¸­æ˜¾å¼æ³¨å†Œæ‰€éœ€æœåŠ¡ï¼Œä»¥ä¿è¯å…¥å£å”¯ä¸€æ€§ã€‚

* **æ³¨å†Œç­–ç•¥**: é€šè¿‡ `service_manager.register_service('mqtt_broker', EmbeddedMQTTBroker(...))` æ³¨å†ŒæœåŠ¡ã€‚å½“éœ€è¦é‡æ–°é…ç½®æˆ–æ›¿æ¢å®ä¾‹æ—¶ï¼Œå†æ¬¡è°ƒç”¨ `register_service` ä¼šè‡ªåŠ¨åœæ­¢æ—§å®ä¾‹å¹¶è§£é™¤å®ƒä¸ Qt ä¿¡å·çš„ç»‘å®šï¼Œé¿å…æ®‹ç•™çº¿ç¨‹æˆ–é‡å¤è®¢é˜…ã€‚
* **ä½•æ—¶è°ƒç”¨**: æ¨èä»…åœ¨åº”ç”¨å¯åŠ¨æˆ–é…ç½®å‘ç”Ÿå˜åŒ–æ—¶è°ƒç”¨ `register_service`ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿æ–°çš„é…ç½®è¢«æ­£ç¡®åŠ è½½ï¼ŒåŒæ—¶é˜²æ­¢æ—§å®ä¾‹ç»§ç»­å“åº”æ¶ˆæ¯ã€‚
* **æ¸…ç†ä¿è¯**: `register_service` å†…éƒ¨ä¼šåœ¨æ›¿æ¢å‰è°ƒç”¨æ—§å®ä¾‹çš„ `stop()` å’Œ `disconnect_signals()`ï¼Œå¹¶ç­‰å¾…ç›¸å…³çº¿ç¨‹ç»“æŸã€‚é‡å¯æˆ–é‡æ–°é…ç½®æ—¶æ— éœ€é¢å¤–æ‰‹åŠ¨æ¸…ç†ã€‚
* **è¿æ¥æµç¨‹**: `MessageBusManager.connect()` ä¼šåœ¨å¯åŠ¨æ¶ˆæ¯æ€»çº¿å‰æ£€æŸ¥ `ServiceState`ã€‚å½“ MQTT æ¨¡å¼é…ç½®ä¸ºåµŒå…¥å¼æ—¶ï¼Œå®ƒä¼šç¡®ä¿ `mqtt_broker` æœåŠ¡å¤„äº `RUNNING` çŠ¶æ€ï¼šå¦‚æœæœåŠ¡å°šæœªå¯åŠ¨åˆ™è°ƒç”¨ `start_service`ï¼ŒåŒæ—¶é˜»å¡ç­‰å¾… `global_signals.service_state_changed` å‘å‡ºçŠ¶æ€å˜æ›´é€šçŸ¥ã€‚è‹¥åœ¨é»˜è®¤è¶…æ—¶æ—¶é—´å†…æœªç­‰åˆ° `RUNNING`ï¼Œä¼šè®°å½•æ˜“è¯»çš„é”™è¯¯æ—¥å¿—å¹¶è·³è¿‡è¿æ¥ï¼Œé¿å…é‡å¤å¯åŠ¨æˆ–æ— é™ç­‰å¾…ã€‚

---

## 5. ä¸€ä¸ªå®Œæ•´çš„ V2 æ¨¡å—ç¤ºä¾‹

è®©æˆ‘ä»¬å°†ä»¥ä¸Šæ‰€æœ‰æ¦‚å¿µæ•´åˆåˆ°ä¸€ä¸ªå®Œæ•´çš„ã€äº‹ä»¶é©±åŠ¨çš„æ¨¡å—ä¸­ã€‚è¿™ä¸ªæ¨¡å—ä¼šç›‘å¬ä¸€ä¸ª MQTT ä¸»é¢˜ï¼ŒéªŒè¯è¾“å…¥çš„æ¸©åº¦æ•°æ®ï¼Œå¹¶æ ¹æ®æ¸©åº¦å€¼è®°å½•ä¸åŒçº§åˆ«çš„æ—¥å¿—ã€‚

**ç›®å½•ç»“æ„:**

```
modules/
â””â”€â”€ smart_thermostat/
    â”œâ”€â”€ manifest.yaml
    â””â”€â”€ smart_thermostat_template.py
```

**`manifest.yaml`:**

```yaml
name: "æ™ºèƒ½æ’æ¸©å™¨"
module_type: "smart_thermostat_v2"
version: "1.1"
description: "ç›‘å¬æ¸©åº¦è¯»æ•°ï¼Œå¦‚æœè¿‡é«˜åˆ™è®°å½•è­¦å‘Šã€‚"

trigger:
  type: event
  config:
    topic: "home/living_room/temperature"

inputs:
  - name: current_temp
    type: float
    description: "å½“å‰çš„æ‘„æ°æ¸©åº¦è¯»æ•°ã€‚"
    required: true

  - name: device_id
    type: string
    description: "ä¼ æ„Ÿå™¨çš„å”¯ä¸€IDã€‚"
    required: false
```

**`smart_thermostat_template.py`:**

```python
def run(context, inputs):
    """
    å¤„ç†æ¸©åº¦ä¼ æ„Ÿå™¨æ•°æ®ã€‚
    """
    task_name = context.task_name
    logger = context.logger

    # ç”±äº manifest.yaml ä¸­è®¾ç½®äº† required: trueï¼Œ
    # æˆ‘ä»¬åœ¨è¿™é‡Œå¯ä»¥å®‰å…¨åœ°ç›´æ¥è®¿é—® 'current_temp'ã€‚
    temperature = inputs['current_temp']
    device_id = inputs.get('device_id', 'æœªçŸ¥è®¾å¤‡') # .get() ç”¨äºå¯é€‰å­—æ®µ

    logger.info(f"[{task_name}] ä» '{device_id}' æ”¶åˆ°æ¸©åº¦æ•°æ®: {temperature}Â°C")

    if temperature > 30.0:
        logger.warning(f"[{task_name}] é«˜æ¸©è­¦æŠ¥ï¼æ¸©åº¦å·²è¾¾åˆ° {temperature}Â°Cã€‚")
    elif temperature < 5.0:
        logger.warning(f"[{task_name}] ä½æ¸©è­¦æŠ¥ï¼æ¸©åº¦å·²é™è‡³ {temperature}Â°Cã€‚")
    else:
        logger.info(f"[{task_name}] æ¸©åº¦ '{temperature}Â°C' åœ¨æ­£å¸¸èŒƒå›´å†…ã€‚")

```

è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•åˆ©ç”¨ V2 æ¶æ„çš„ç‰¹æ€§â€”â€”å£°æ˜å¼çš„ `manifest.yaml`ã€å¥å£®çš„è¾“å…¥éªŒè¯å’Œä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„æ—¥å¿—è®°å½•â€”â€”æ¥åˆ›å»ºä¸€ä¸ªç®€æ´ã€å¯é ä¸”æ˜“äºç»´æŠ¤çš„æ¨¡å—ã€‚

---

## 7. è®¸å¯ä¸åˆ†å‘æ¸…å•

* **é™„å¸¦ MIT æ¡æ¬¾**ï¼šä»»ä½•äº¤ä»˜ç‰©éƒ½å¿…é¡»åŒ…å«ä»“åº“æ ¹ç›®å½•çš„ `LICENSE` æ–‡ä»¶ã€‚è¯·åœ¨ PyInstaller é…ç½®ï¼ˆè¯¦è§ README æŒ‡å¼•ï¼‰æˆ–æœªæ¥çš„æ‰“åŒ…è„šæœ¬ä¸­æ˜¾å¼æ·»åŠ è¯¥æ–‡ä»¶ã€‚
* **æ˜ç¡® PyQt5 åˆè§„ç­–ç•¥**ï¼šPyQt5 åœ¨æœªè´­ä¹°å•†ä¸šè®¸å¯æ—¶ä»¥ GPL v3 æ–¹å¼å‘å¸ƒã€‚è‹¥ä»¥ MIT è®¸å¯åˆ†å‘é¡¹ç›®ï¼Œè¯·ç¡®ä¿ï¼š
  * æŒ‰ GPL è¦æ±‚å…¬å¼€å…¨éƒ¨æºä»£ç å¹¶æ»¡è¶³ä¼ æŸ“æ€§æ¡æ¬¾ï¼Œæˆ–
  * ä» Riverbank Computing è·å–å•†ä¸šè®¸å¯ã€‚
  è¯·åœ¨éƒ¨ç½²è¯´æ˜ä¸­è®°å½•æ‰€é‡‡ç”¨çš„ç­–ç•¥ï¼Œæ–¹ä¾¿ä¸‹æ¸¸ä½¿ç”¨è€…ç†è§£æˆæƒè¾¹ç•Œã€‚
* **ç¬¬ä¸‰æ–¹ä¾èµ–æ¦‚è§ˆ**ï¼šå½“å‰è¿è¡Œæ—¶ä¾èµ–åŠå…¶è®¸å¯è¯å¦‚ä¸‹ï¼š
  * psutil â€“ BSD 3-Clause
  * PyYAML â€“ MIT
  * paho-mqtt â€“ Eclipse Distribution License 1.0
  * APScheduler â€“ MIT
  * qtawesome â€“ MIT
  * amqtt â€“ MIT
  * pyqtgraph â€“ MIT
  * PyAutoGUI â€“ BSD 3-Clause
  * Markdown 3.4.4 â€“ BSD 3-Clause
  è¿™äº›è®¸å¯è¯ä¸ MIT å…¼å®¹ï¼Œä½†åœ¨æ–°å¢ä¾èµ–æ—¶åº”é‡æ–°å®¡æŸ¥ã€‚
